<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini PDF Quiz Generator (Client-Side)</title>
    
    <!-- LIBRARIES: These will be loaded by the browser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    
    <!-- PDF.js library (modern version) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; text-align: center; margin-bottom: 20px; }
        h2 { display: flex; align-items: center; }
        label { display: block; margin-bottom: 6px; font-weight: bold; color: #5f6368; }
        .api-key-warning { background-color: #fef7e0; color: #5f6368; padding: 12px; border: 1px solid #fde293; border-radius: 4px; margin-bottom: 20px; font-size: 14px; }
        .api-key-warning strong { color: #d93025; }
        input[type="file"] { width: 100%; padding: 12px; margin-bottom: 18px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; background-color: #f8f9fa; }
        button { background-color: #1a73e8; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        button:hover { background-color: #1765cf; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #responseArea { margin-top: 25px; padding: 20px; border: 1px solid #e0e0e0; background-color: #f8f9fa; border-radius: 4px; min-height: 150px; white-space: pre-wrap; }
        #responseArea table { border-collapse: collapse; width: 100%; margin-bottom: 1em; font-size: 0.9em; }
        #responseArea th, #responseArea td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        #responseArea th { background-color: #e9ecef; }
        #responseArea pre { background-color: #e8eaed; padding: 12px; border-radius: 4px; overflow-x: auto; }
        #responseArea code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; }
        #loadingIndicator { display: none; margin-top: 10px; font-style: italic; color: #5f6368; }
        #saveToWordBtn { margin-left: 15px; padding: 8px 10px; font-size: 18px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; line-height: 1; }
        #saveToWordBtn:hover { background-color: #45a049; }
        #saveToWordBtn:disabled { background-color: #ccc; cursor: not-allowed; }
        .error { color: red; font-weight: bold; }
        .status { color: #1a73e8; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ITE Quiz Generator</h1>
        
        
        <label for="pdfFile">Upload PDF Notes File:</label>
        <input type="file" id="pdfFile" accept=".pdf">
        
        <button id="submitBtn">Generate Quiz</button>
        <div id="loadingIndicator">Please wait...</div>

        <h2>
            Response:
            <button id="saveToWordBtn" title="Save as Word Document" disabled>ðŸ’¾</button>
        </h2>
        <div id="responseArea">Upload a PDF and click "Generate Quiz" to see the results.</div>
    </div>

    <script>
        window.addEventListener('load', () => {
            const pdfFileInput = document.getElementById('pdfFile');
            const submitBtn = document.getElementById('submitBtn');
            const responseArea = document.getElementById('responseArea');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const saveToWordBtn = document.getElementById('saveToWordBtn');

            // Configure PDF.js worker
            if (window.pdfjsLib) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
                responseArea.innerHTML = `<p class="status">Ready! Please upload a PDF to generate a quiz.</p>`;
            } else {
                console.error("PDF.js library failed to load.");
                responseArea.innerHTML = `<p class="error">Error: Could not load the PDF processing library. Please check your internet connection and try again.</p>`;
                return;
            }


            const GEMINI_API_KEY = "AIzaSyByShtQwlwxtJsVMqa95jlR7lP64APm-bk";
                        const GEMINI_MODEL = "gemini-1.5-flash-latest";
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;


            submitBtn.addEventListener('click', async () => {
                const file = pdfFileInput.files[0];
                if (!file) {
                    responseArea.innerHTML = `<p class="error">Please select a PDF file first.</p>`;
                    return;
                }

                setLoadingState(true, "Reading PDF content...");

                try {
                    const pdfText = await extractTextFromPdf(file);
                    if (!pdfText.trim()) {
                        throw new Error("Could not extract any text from the PDF. It might be an image-based PDF or corrupted.");
                    }

                    setLoadingState(true, "PDF content extracted. Sending to LLM...");
                    
                    const prompt = `
                        Based ONLY on the content of the following text from a PDF document, please act as a teacher and create a multiple-choice quiz.
                        Instructions:
                        1. Generate 20 multiple-choice questions.
                        2. Each question should test a key concept from the provided text.
                        3. For each question, provide 4 options (A, B, C, D).
                        4. After the options for each question, clearly indicate the correct answer in the format "Correct Answer: [Letter]".
                        5. Ensure all questions and answers are derived exclusively from the text below. Do not use any external knowledge.
                        6. Format the output cleanly using Markdown.
                        7. 5 SAQs (Short Answer Questions).
                        8. clearly indicate the correct answer for SAQs.
                        --- PDF TEXT START ---
                        ${pdfText}
                        --- PDF TEXT END ---
                    `;

                    
                    const requestBody = {
                        "contents": [{"parts": [{"text": prompt}]}],
                        "generationConfig": {
                            "temperature": 0.5,
                            "maxOutputTokens": 4096,
                        }
                    };

                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        
                        throw new Error(`Gemini API Error: ${data.error?.message || response.statusText} (Status: ${response.status})`);
                    }

                    
                    const quizContent = data.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!quizContent) {
                         throw new Error("Received an empty or invalid response from the Gemini API. The content might have been blocked for safety reasons.");
                    }

                    responseArea.innerHTML = marked.parse(quizContent);
                    saveToWordBtn.disabled = false;

                } catch (error) {
                    console.error("An error occurred:", error);
                    responseArea.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                    saveToWordBtn.disabled = true;
                } finally {
                    setLoadingState(false);
                }
            });

            function setLoadingState(isLoading, message = '') {
                if (isLoading) {
                    responseArea.innerHTML = "";
                    submitBtn.disabled = true;
                    saveToWordBtn.disabled = true;
                    loadingIndicator.textContent = message;
                    loadingIndicator.style.display = 'block';
                } else {
                    submitBtn.disabled = false;
                    loadingIndicator.style.display = 'none';
                }
            }

            async function extractTextFromPdf(file) {
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = async function(event) {
                        try {
                            const typedarray = new Uint8Array(event.target.result);
                            const loadingTask = pdfjsLib.getDocument(typedarray);
                            const pdf = await loadingTask.promise;
                            let fullText = '';
                            
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n\n';
                            }
                            
                            resolve(fullText);
                        } catch (error) {
                            reject(new Error(`PDF processing error: ${error.message}`));
                        }
                    };
                    reader.onerror = (error) => reject(new Error(`File reading error: ${error.message}`));
                    reader.readAsArrayBuffer(file);
                });
            }

            saveToWordBtn.addEventListener('click', () => {
                const contentHTML = responseArea.innerHTML;
                if (contentHTML.trim() === "" || responseArea.querySelector('.error')) {
                    alert("No valid content to save or content contains an error.");
                    return;
                }
                try {
                    const converted = htmlDocx.asBlob(contentHTML);
                    saveAs(converted, 'GeneratedQuiz.docx');
                } catch (e) {
                    console.error("Error generating DOCX:", e);
                    alert("Error generating Word document. Please check the console for details.");
                }
            });

            if (window.marked) {
                marked.setOptions({
                    renderer: new marked.Renderer(),
                    pedantic: false, gfm: true, breaks: true,
                    sanitize: false, smartypants: false, xhtml: false
                });
            }
        });
    </script>
</body>
</html>